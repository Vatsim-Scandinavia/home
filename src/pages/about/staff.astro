---
const SiteTitle = "Staff";
import Layout from "../../layout/Layout.astro";
import StaffCard from "../../components/StaffCard.astro";
import staffData from "../../data/staff-positions.json";

// Helper function to check if member is in a section
function isInSection(member: any, sectionName: string): boolean {
    return member.section && member.section.includes(sectionName);
}

// Get vACC Director
const director = staffData.staff.find(
    (member) => isInSection(member, "director")
);

// Get board members
const boardMembers = staffData.staff.filter(
    (member) => 
        isInSection(member, "board") && 
        member.title !== "vACC Director"
);

// Get tech team (technical or dpo sections, but not board members)
const techTeam = staffData.staff.filter(
    (member) => 
        (isInSection(member, "technical") || isInSection(member, "dpo")) &&
        !isInSection(member, "board")
);

// Get event team (event sections, but not board members)
const eventTeam = staffData.staff.filter(
    (member) => 
        isInSection(member, "event") &&
        !isInSection(member, "board")
);

// Get country staff (includes country directors, training, event staff, and country-specific roles)
// Exclude vACC Director, board-only members & tech team
const countryStaff = staffData.staff.filter(
    (member) => {
        // Exclude vACC Director
        if (member.title === "vACC Director") return false;
        
        // Exclude tech team
        if (isInSection(member, "technical") || isInSection(member, "dpo")) return false;
        
        // Exclude navdata
        if (isInSection(member, "navdata")) return false;
        
        // Exclude board-only members (not country directors)
        if (isInSection(member, "board") && !member.title.includes("Director of")) return false;
        
        // Include country directors, training, event staff, and country-specific roles
        return member.title.includes("Director of") || 
               isInSection(member, "training") || 
               isInSection(member, "event") ||
               isInSection(member, "denmark") ||
               isInSection(member, "norway") ||
               isInSection(member, "sweden") ||
               isInSection(member, "finland") ||
               isInSection(member, "iceland");
    }
);

// Group country staff by area using only the defined sections
// Sections now include area names (e.g., ["training", "denmark"], ["event", "finland"])
const countryGroups: { [key: string]: any[] } = {};

// Initialize groups for each defined area
staffData.areas.forEach((area) => {
    countryGroups[area.name] = [];
});

// Create a mapping from area titles to area codes
const areaTitleToCode: { [key: string]: string } = {};
staffData.areas.forEach((area) => {
    areaTitleToCode[area.title.toLowerCase()] = area.name;
});

// Group staff by area based on their section array
// The section array contains area names (denmark, norway, sweden, finland, iceland)
countryStaff.forEach((member) => {
    const memberSections = member.section || [];
    
    // Find area name in the member's sections
    // Sections can contain: "denmark", "norway", "sweden", "finland", "iceland"
    const areaInSection = memberSections.find((s: string) => {
        const sectionLower = s.toLowerCase();
        return areaTitleToCode[sectionLower] !== undefined;
    });
    
    if (areaInSection) {
        const areaCode = areaTitleToCode[areaInSection.toLowerCase()];
        if (areaCode) {
            countryGroups[areaCode].push(member);
        }
    }
});

// Sort function for country staff
function getTitleSortOrder(title: string): number {
    // "Director of" (not Assistant Director) should be first
    if (title.startsWith("Director of") && !title.includes("Assistant")) return 1;
    // Assistant Director comes after main Director
    if (title.includes("Assistant Director")) return 2;
    // Community Lead after Directors
    if (title.includes("Community Lead")) return 3;
    if (title.includes("Training Manager")) return 4;
    if (title.includes("Training Assistant")) return 5;
    if (title.includes("Event")) return 6;
    return 7;
}

// Sort staff within each country
Object.keys(countryGroups).forEach((country) => {
    countryGroups[country].sort((a, b) => {
        const orderA = getTitleSortOrder(a.title);
        const orderB = getTitleSortOrder(b.title);
        if (orderA !== orderB) return orderA - orderB;
        return a.title.localeCompare(b.title);
    });
});

// Country order for display
const countryOrder = ["DK", "NO", "SE", "FI", "IS"];
const countryNames: { [key: string]: string } = {
    "DK": "Denmark",
    "NO": "Norway",
    "SE": "Sweden",
    "FI": "Finland",
    "IS": "Iceland"
};
---

<Layout SiteTitle={`${SiteTitle} | VATSIM Scandinavia`}>
    <div class="w-fit mx-auto">
        <h1 class="text-4xl font-bold mb-2 text-gray-900 dark:text-white">Staff</h1>
        <p class="text-gray-600 dark:text-gray-400 mb-8">
            Meet the dedicated individuals who make VATSIM Scandinavia a great community.
        </p>

        {/* Director Section */}
        {director && (
            <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white text-center sm:text-left">vACC Director</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 md:gap-6 justify-items-center sm:justify-items-start">
                    <StaffCard member={director} />
                </div>
            </div>
        )}

        {/* Board Members Section */}
        {boardMembers.length > 0 && (
            <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white text-center sm:text-left">Board of Directors</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-2 justify-items-center sm:justify-items-start">
                    {boardMembers.map((member) => (
                        <StaffCard member={member} />
                    ))}
                </div>
            </div>
        )}

        {/* Countries Section */}
        <div class="mb-12">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white text-center md:text-left">Countries</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 md:gap-8 justify-items-center md:justify-items-start">
                {countryOrder.map((countryCode) => {
                    const countryStaffList = countryGroups[countryCode];
                    if (!countryStaffList || countryStaffList.length === 0) return null;
                    
                    return (
                        <div class="flex flex-col w-full">
                            <div class="flex items-center gap-3 mb-4 justify-center md:justify-start">
                                <img 
                                    src={`/img/icons/${countryCode}.svg`} 
                                    alt={countryNames[countryCode] || countryCode}
                                    class="w-6 h-6"
                                    loading="lazy"
                                />
                                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                                    {countryNames[countryCode] || countryCode}
                                </h3>
                            </div>
                            <div class="flex flex-col gap-4 items-center md:items-stretch">
                                {countryStaffList.map((member) => (
                                    <StaffCard member={member} />
                                ))}
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>

        {/* Event Team Section */}
        {eventTeam.length > 0 && (
            <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white text-center sm:text-left">Event Team</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 md:gap-6 justify-items-center sm:justify-items-start">
                    {eventTeam.map((member) => (
                        <StaffCard member={member} />
                    ))}
                </div>
            </div>
        )}

        {/* Tech Team Section */}
        {techTeam.length > 0 && (
            <div class="mb-12">
                <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white text-center sm:text-left">Tech Team</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 md:gap-6 justify-items-center sm:justify-items-start">
                    {techTeam.map((member) => (
                        <StaffCard member={member} />
                    ))}
                </div>
            </div>
        )}
    </div>
</Layout>
